<?php
/**
 * Finn alle kinoer i Filmweb og lagre lokasjon, filmer, forestillinger og plakat.
 *
 * Denne filen finner alle kinoene som ligger i FilmWeb og henter kinoprogram inkl.
 * filmer, forestillinger, plakat og billettlenker.
 *
 * @return void
 */

require __DIR__ . '/functions.php';

/**
 * Filmweb sin API gir resultater på to bokstaver, så her er alle tobokstavs-
 * kombinasjoner som gir mening å søke etter.
 */
$letter_combos = array(
  "AA",
  "AB",
  "AC",
  "AD",
  "AE",
  "AF",
  "AG",
  "AH",
  "AI",
  "AJ",
  "AK",
  "AL",
  "AM",
  "AN",
  "AO",
  "AP",
  "AQ",
  "AR",
  "AS",
  "AT",
  "AU",
  "AV",
  "AW",
  "AX",
  "AY",
  "AZ",
  "AÆ",
  "AØ",
  "AÅ",
  "BA",
  "BB",
  "BC",
  "BD",
  "BE",
  "BF",
  "BG",
  "BH",
  "BI",
  "BJ",
  "BK",
  "BL",
  "BM",
  "BN",
  "BO",
  "BP",
  "BQ",
  "BR",
  "BS",
  "BT",
  "BU",
  "BV",
  "BW",
  "BX",
  "BY",
  "BZ",
  "BÆ",
  "BØ",
  "BÅ",
  "CA",
  "CB",
  "CC",
  "CD",
  "CE",
  "CF",
  "CG",
  "CH",
  "CI",
  "CJ",
  "CK",
  "CL",
  "CM",
  "CN",
  "CO",
  "CP",
  "CQ",
  "CR",
  "CS",
  "CT",
  "CU",
  "CV",
  "CW",
  "CX",
  "CY",
  "CZ",
  "CÆ",
  "CØ",
  "CÅ",
  "DA",
  "DB",
  "DC",
  "DD",
  "DE",
  "DF",
  "DG",
  "DH",
  "DI",
  "DJ",
  "DK",
  "DL",
  "DM",
  "DN",
  "DO",
  "DP",
  "DQ",
  "DR",
  "DS",
  "DT",
  "DU",
  "DV",
  "DW",
  "DX",
  "DY",
  "DZ",
  "DÆ",
  "DØ",
  "DÅ",
  "EA",
  "EB",
  "EC",
  "ED",
  "EE",
  "EF",
  "EG",
  "EH",
  "EI",
  "EJ",
  "EK",
  "EL",
  "EM",
  "EN",
  "EO",
  "EP",
  "EQ",
  "ER",
  "ES",
  "ET",
  "EU",
  "EV",
  "EW",
  "EX",
  "EY",
  "EZ",
  "EÆ",
  "EØ",
  "EÅ",
  "FA",
  "FB",
  "FC",
  "FD",
  "FE",
  "FF",
  "FG",
  "FH",
  "FI",
  "FJ",
  "FK",
  "FL",
  "FM",
  "FN",
  "FO",
  "FP",
  "FQ",
  "FR",
  "FS",
  "FT",
  "FU",
  "FV",
  "FW",
  "FX",
  "FY",
  "FZ",
  "FÆ",
  "FØ",
  "FÅ",
  "GA",
  "GB",
  "GC",
  "GD",
  "GE",
  "GF",
  "GG",
  "GH",
  "GI",
  "GJ",
  "GK",
  "GL",
  "GM",
  "GN",
  "GO",
  "GP",
  "GQ",
  "GR",
  "GS",
  "GT",
  "GU",
  "GV",
  "GW",
  "GX",
  "GY",
  "GZ",
  "GÆ",
  "GØ",
  "GÅ",
  "HA",
  "HB",
  "HC",
  "HD",
  "HE",
  "HF",
  "HG",
  "HH",
  "HI",
  "HJ",
  "HK",
  "HL",
  "HM",
  "HN",
  "HO",
  "HP",
  "HQ",
  "HR",
  "HS",
  "HT",
  "HU",
  "HV",
  "HW",
  "HX",
  "HY",
  "HZ",
  "HÆ",
  "HØ",
  "HÅ",
  "IA",
  "IB",
  "IC",
  "ID",
  "IE",
  "IF",
  "IG",
  "IH",
  "II",
  "IJ",
  "IK",
  "IL",
  "IM",
  "IN",
  "IO",
  "IP",
  "IQ",
  "IR",
  "IS",
  "IT",
  "IU",
  "IV",
  "IW",
  "IX",
  "IY",
  "IZ",
  "IÆ",
  "IØ",
  "IÅ",
  "JA",
  "JB",
  "JC",
  "JD",
  "JE",
  "JF",
  "JG",
  "JH",
  "JI",
  "JJ",
  "JK",
  "JL",
  "JM",
  "JN",
  "JO",
  "JP",
  "JQ",
  "JR",
  "JS",
  "JT",
  "JU",
  "JV",
  "JW",
  "JX",
  "JY",
  "JZ",
  "JÆ",
  "JØ",
  "JÅ",
  "KA",
  "KB",
  "KC",
  "KD",
  "KE",
  "KF",
  "KG",
  "KH",
  "KI",
  "KJ",
  "KK",
  "KL",
  "KM",
  "KN",
  "KO",
  "KP",
  "KQ",
  "KR",
  "KS",
  "KT",
  "KU",
  "KV",
  "KW",
  "KX",
  "KY",
  "KZ",
  "KÆ",
  "KØ",
  "KÅ",
  "LA",
  "LB",
  "LC",
  "LD",
  "LE",
  "LF",
  "LG",
  "LH",
  "LI",
  "LJ",
  "LK",
  "LL",
  "LM",
  "LN",
  "LO",
  "LP",
  "LQ",
  "LR",
  "LS",
  "LT",
  "LU",
  "LV",
  "LW",
  "LX",
  "LY",
  "LZ",
  "LÆ",
  "LØ",
  "LÅ",
  "MA",
  "MB",
  "MC",
  "MD",
  "ME",
  "MF",
  "MG",
  "MH",
  "MI",
  "MJ",
  "MK",
  "ML",
  "MM",
  "MN",
  "MO",
  "MP",
  "MQ",
  "MR",
  "MS",
  "MT",
  "MU",
  "MV",
  "MW",
  "MX",
  "MY",
  "MZ",
  "MÆ",
  "MØ",
  "MÅ",
  "NA",
  "NB",
  "NC",
  "ND",
  "NE",
  "NF",
  "NG",
  "NH",
  "NI",
  "NJ",
  "NK",
  "NL",
  "NM",
  "NN",
  "NO",
  "NP",
  "NQ",
  "NR",
  "NS",
  "NT",
  "NU",
  "NV",
  "NW",
  "NX",
  "NY",
  "NZ",
  "NÆ",
  "NØ",
  "NÅ",
  "OA",
  "OB",
  "OC",
  "OD",
  "OE",
  "OF",
  "OG",
  "OH",
  "OI",
  "OJ",
  "OK",
  "OL",
  "OM",
  "ON",
  "OO",
  "OP",
  "OQ",
  "OR",
  "OS",
  "OT",
  "OU",
  "OV",
  "OW",
  "OX",
  "OY",
  "OZ",
  "OÆ",
  "OØ",
  "OÅ",
  "PA",
  "PB",
  "PC",
  "PD",
  "PE",
  "PF",
  "PG",
  "PH",
  "PI",
  "PJ",
  "PK",
  "PL",
  "PM",
  "PN",
  "PO",
  "PP",
  "PQ",
  "PR",
  "PS",
  "PT",
  "PU",
  "PV",
  "PW",
  "PX",
  "PY",
  "PZ",
  "PÆ",
  "PØ",
  "PÅ",
  "RA",
  "RB",
  "RC",
  "RD",
  "RE",
  "RF",
  "RG",
  "RH",
  "RI",
  "RJ",
  "RK",
  "RL",
  "RM",
  "RN",
  "RO",
  "RP",
  "RQ",
  "RR",
  "RS",
  "RT",
  "RU",
  "RV",
  "RW",
  "RX",
  "RY",
  "RZ",
  "RÆ",
  "RØ",
  "RÅ",
  "SA",
  "SB",
  "SC",
  "SD",
  "SE",
  "SF",
  "SG",
  "SH",
  "SI",
  "SJ",
  "SK",
  "SL",
  "SM",
  "SN",
  "SO",
  "SP",
  "SQ",
  "SR",
  "SS",
  "ST",
  "SU",
  "SV",
  "SW",
  "SX",
  "SY",
  "SZ",
  "SÆ",
  "SØ",
  "SÅ",
  "TA",
  "TB",
  "TC",
  "TD",
  "TE",
  "TF",
  "TG",
  "TH",
  "TI",
  "TJ",
  "TK",
  "TL",
  "TM",
  "TN",
  "TO",
  "TP",
  "TQ",
  "TR",
  "TS",
  "TT",
  "TU",
  "TV",
  "TW",
  "TX",
  "TY",
  "TZ",
  "TÆ",
  "TØ",
  "TÅ",
  "UA",
  "UB",
  "UC",
  "UD",
  "UE",
  "UF",
  "UG",
  "UH",
  "UI",
  "UJ",
  "UK",
  "UL",
  "UM",
  "UN",
  "UO",
  "UP",
  "UQ",
  "UR",
  "US",
  "UT",
  "UU",
  "UV",
  "UW",
  "UX",
  "UY",
  "UZ",
  "UÆ",
  "UØ",
  "UÅ",
  "VA",
  "VB",
  "VC",
  "VD",
  "VE",
  "VF",
  "VG",
  "VH",
  "VI",
  "VJ",
  "VK",
  "VL",
  "VM",
  "VN",
  "VO",
  "VP",
  "VQ",
  "VR",
  "VS",
  "VT",
  "VU",
  "VV",
  "VW",
  "VX",
  "VY",
  "VZ",
  "VÆ",
  "VØ",
  "VÅ",
  "YA",
  "YB",
  "YC",
  "YD",
  "YE",
  "YF",
  "YG",
  "YH",
  "YI",
  "YJ",
  "YK",
  "YL",
  "YM",
  "YN",
  "YO",
  "YP",
  "YQ",
  "YR",
  "YS",
  "YT",
  "YU",
  "YV",
  "YW",
  "YX",
  "YY",
  "YZ",
  "YÆ",
  "YØ",
  "YÅ",
  "ÆA",
  "ÆB",
  "ÆC",
  "ÆD",
  "ÆE",
  "ÆF",
  "ÆG",
  "ÆH",
  "ÆI",
  "ÆJ",
  "ÆK",
  "ÆL",
  "ÆM",
  "ÆN",
  "ÆO",
  "ÆP",
  "ÆQ",
  "ÆR",
  "ÆS",
  "ÆT",
  "ÆU",
  "ÆV",
  "ÆW",
  "ÆX",
  "ÆY",
  "ÆZ",
  "ÆÆ",
  "ÆØ",
  "ÆÅ",
  "ØA",
  "ØB",
  "ØC",
  "ØD",
  "ØE",
  "ØF",
  "ØG",
  "ØH",
  "ØI",
  "ØJ",
  "ØK",
  "ØL",
  "ØM",
  "ØN",
  "ØO",
  "ØP",
  "ØQ",
  "ØR",
  "ØS",
  "ØT",
  "ØU",
  "ØV",
  "ØW",
  "ØX",
  "ØY",
  "ØZ",
  "ØÆ",
  "ØØ",
  "ØÅ",
  "ÅA",
  "ÅB",
  "ÅC",
  "ÅD",
  "ÅE",
  "ÅF",
  "ÅG",
  "ÅH",
  "ÅI",
  "ÅJ",
  "ÅK",
  "ÅL",
  "ÅM",
  "ÅN",
  "ÅO",
  "ÅP",
  "ÅQ",
  "ÅR",
  "ÅS",
  "ÅT",
  "ÅU",
  "ÅV",
  "ÅW",
  "ÅX",
  "ÅY",
  "ÅZ",
  "ÅÆ",
  "ÅØ",
  "ÅÅ"
);

/**
 * Filmweb sitt GraphQL-endpoint for kinosøk
 */
function cinema_query($letter_combo = '')
{
    return 'https://skynet.filmweb.no/MovieInfoQs/graphql/?query=query($searchText:String){cinemaQuery{searchForLocations(searchText:$searchText){name}}}&variables={"searchText":"'. urlencode($letter_combo) . '"}';
}

/**
 * Gi oss Filmweb sitt GraphQL-endpoint for filmsøk på en lokasjon
 */
function movie_query($location = '')
{
    return 'https://skynet.filmweb.no/MovieInfoQs/graphql/?query=query($location:String){movieQuery{getCurrentMovies(location:$location,removePastShows:true){mainVersionId%20title%20genres%20lengthInMinutes%20rating%20poster{versions{url}}%20sanityImagePosterUrl%20shows{firmName%20showStart%20screenName%20ticketSaleUrl%20theaterName%20movieVersionId}}}}&variables={%22location%22:%22' . urlencode($location) . '%22}';
}

$all_locations = [];

foreach ($letter_combos as $combo) {

    if ($request = file_get_contents(cinema_query($combo))) {

        $result = json_decode($request);

        $locations = $result->data->cinemaQuery->searchForLocations;

        if ($result && !empty($locations)) {

            foreach($locations as $location) {

                if (!empty($location->name)) {

                    $location_array = array(
                        "name" => $location->name,
                        "slug" => get_slug($location->name)
                    );

                    if (!in_array($location_array, $all_locations)) {

                        array_push($all_locations, $location_array);

                        /**
                         * Hent filmer for denne kinoen
                         */
                        logg("🍿 Henter filmer for " . $location->name . "...");

                        $query_result = json_decode(file_get_contents(movie_query($location->name)));
                        $movies = $query_result->data->movieQuery->getCurrentMovies;

                        if ($query_result && !empty($movies)) {

                            $location_json = LOCATIONS_DIR . $location_array['slug'] . '.json';

                            file_put_contents($location_json, json_encode($movies));

                            foreach($movies as $movie) {

                                if (!empty($movie->sanityImagePosterUrl)) {

                                    $filename = IMG_DIR . $movie->mainVersionId . ".webp";

                                    if (!file_exists($filename)) {

                                        $poster_url = preg_replace('/auto=format/', 'fm=webp', $movie->sanityImagePosterUrl);

                                        list($width, $height) = getimagesize($poster_url);

                                        if ($width < 0 && $height > 0) {

                                          logg("– Laster ned plakat til " . $movie->title . "...");

                                          $new_width = 450;
                                          $ratio = $height / $width;
                                          $new_height = intval($new_width * $ratio);

                                          $image_p = imagecreatetruecolor($new_width, $new_height);
                                          $image = imagecreatefromwebp($poster_url);
                                          imagecopyresampled($image_p, $image, 0, 0, 0, 0, $new_width, $new_height, $width, $height);

                                          imagewebp($image_p, IMG_DIR . $movie->mainVersionId . ".webp", 50);

                                          imagedestroy($image);
                                          imagedestroy($image_p);
                                        }
                                    }

                                } else {
                                    //logg("– Fikk ikke tak i plakat til " . $movie->title . "...");
                                }

                            }

                        }
                    }
                }
            }
        }
    }
}

file_put_contents( LOCATIONS_DIR . 'all_locations.json', json_encode($all_locations));
delete_old_locations('-1 day 5 minutes');
