<?php
/**
 * Finn alle kinoer i Filmweb og lagre lokasjon, filmer, forestillinger og plakat.
 *
 * Denne filen finner alle kinoene som ligger i FilmWeb og henter kinoprogram inkl.
 * filmer, forestillinger, plakat og billettlenker.
 *
 * @return void
 */

require __DIR__ . '/functions.php';

/**
 * Filmweb sin API gir resultater pÃ¥ to bokstaver, sÃ¥ her er alle tobokstavs-
 * kombinasjoner som gir mening Ã¥ sÃ¸ke etter.
 */
$letter_combos = array(
  "AA",
  "AB",
  "AC",
  "AD",
  "AE",
  "AF",
  "AG",
  "AH",
  "AI",
  "AJ",
  "AK",
  "AL",
  "AM",
  "AN",
  "AO",
  "AP",
  "AQ",
  "AR",
  "AS",
  "AT",
  "AU",
  "AV",
  "AW",
  "AX",
  "AY",
  "AZ",
  "AÃ†",
  "AÃ˜",
  "AÃ…",
  "BA",
  "BB",
  "BC",
  "BD",
  "BE",
  "BF",
  "BG",
  "BH",
  "BI",
  "BJ",
  "BK",
  "BL",
  "BM",
  "BN",
  "BO",
  "BP",
  "BQ",
  "BR",
  "BS",
  "BT",
  "BU",
  "BV",
  "BW",
  "BX",
  "BY",
  "BZ",
  "BÃ†",
  "BÃ˜",
  "BÃ…",
  "CA",
  "CB",
  "CC",
  "CD",
  "CE",
  "CF",
  "CG",
  "CH",
  "CI",
  "CJ",
  "CK",
  "CL",
  "CM",
  "CN",
  "CO",
  "CP",
  "CQ",
  "CR",
  "CS",
  "CT",
  "CU",
  "CV",
  "CW",
  "CX",
  "CY",
  "CZ",
  "CÃ†",
  "CÃ˜",
  "CÃ…",
  "DA",
  "DB",
  "DC",
  "DD",
  "DE",
  "DF",
  "DG",
  "DH",
  "DI",
  "DJ",
  "DK",
  "DL",
  "DM",
  "DN",
  "DO",
  "DP",
  "DQ",
  "DR",
  "DS",
  "DT",
  "DU",
  "DV",
  "DW",
  "DX",
  "DY",
  "DZ",
  "DÃ†",
  "DÃ˜",
  "DÃ…",
  "EA",
  "EB",
  "EC",
  "ED",
  "EE",
  "EF",
  "EG",
  "EH",
  "EI",
  "EJ",
  "EK",
  "EL",
  "EM",
  "EN",
  "EO",
  "EP",
  "EQ",
  "ER",
  "ES",
  "ET",
  "EU",
  "EV",
  "EW",
  "EX",
  "EY",
  "EZ",
  "EÃ†",
  "EÃ˜",
  "EÃ…",
  "FA",
  "FB",
  "FC",
  "FD",
  "FE",
  "FF",
  "FG",
  "FH",
  "FI",
  "FJ",
  "FK",
  "FL",
  "FM",
  "FN",
  "FO",
  "FP",
  "FQ",
  "FR",
  "FS",
  "FT",
  "FU",
  "FV",
  "FW",
  "FX",
  "FY",
  "FZ",
  "FÃ†",
  "FÃ˜",
  "FÃ…",
  "GA",
  "GB",
  "GC",
  "GD",
  "GE",
  "GF",
  "GG",
  "GH",
  "GI",
  "GJ",
  "GK",
  "GL",
  "GM",
  "GN",
  "GO",
  "GP",
  "GQ",
  "GR",
  "GS",
  "GT",
  "GU",
  "GV",
  "GW",
  "GX",
  "GY",
  "GZ",
  "GÃ†",
  "GÃ˜",
  "GÃ…",
  "HA",
  "HB",
  "HC",
  "HD",
  "HE",
  "HF",
  "HG",
  "HH",
  "HI",
  "HJ",
  "HK",
  "HL",
  "HM",
  "HN",
  "HO",
  "HP",
  "HQ",
  "HR",
  "HS",
  "HT",
  "HU",
  "HV",
  "HW",
  "HX",
  "HY",
  "HZ",
  "HÃ†",
  "HÃ˜",
  "HÃ…",
  "IA",
  "IB",
  "IC",
  "ID",
  "IE",
  "IF",
  "IG",
  "IH",
  "II",
  "IJ",
  "IK",
  "IL",
  "IM",
  "IN",
  "IO",
  "IP",
  "IQ",
  "IR",
  "IS",
  "IT",
  "IU",
  "IV",
  "IW",
  "IX",
  "IY",
  "IZ",
  "IÃ†",
  "IÃ˜",
  "IÃ…",
  "JA",
  "JB",
  "JC",
  "JD",
  "JE",
  "JF",
  "JG",
  "JH",
  "JI",
  "JJ",
  "JK",
  "JL",
  "JM",
  "JN",
  "JO",
  "JP",
  "JQ",
  "JR",
  "JS",
  "JT",
  "JU",
  "JV",
  "JW",
  "JX",
  "JY",
  "JZ",
  "JÃ†",
  "JÃ˜",
  "JÃ…",
  "KA",
  "KB",
  "KC",
  "KD",
  "KE",
  "KF",
  "KG",
  "KH",
  "KI",
  "KJ",
  "KK",
  "KL",
  "KM",
  "KN",
  "KO",
  "KP",
  "KQ",
  "KR",
  "KS",
  "KT",
  "KU",
  "KV",
  "KW",
  "KX",
  "KY",
  "KZ",
  "KÃ†",
  "KÃ˜",
  "KÃ…",
  "LA",
  "LB",
  "LC",
  "LD",
  "LE",
  "LF",
  "LG",
  "LH",
  "LI",
  "LJ",
  "LK",
  "LL",
  "LM",
  "LN",
  "LO",
  "LP",
  "LQ",
  "LR",
  "LS",
  "LT",
  "LU",
  "LV",
  "LW",
  "LX",
  "LY",
  "LZ",
  "LÃ†",
  "LÃ˜",
  "LÃ…",
  "MA",
  "MB",
  "MC",
  "MD",
  "ME",
  "MF",
  "MG",
  "MH",
  "MI",
  "MJ",
  "MK",
  "ML",
  "MM",
  "MN",
  "MO",
  "MP",
  "MQ",
  "MR",
  "MS",
  "MT",
  "MU",
  "MV",
  "MW",
  "MX",
  "MY",
  "MZ",
  "MÃ†",
  "MÃ˜",
  "MÃ…",
  "NA",
  "NB",
  "NC",
  "ND",
  "NE",
  "NF",
  "NG",
  "NH",
  "NI",
  "NJ",
  "NK",
  "NL",
  "NM",
  "NN",
  "NO",
  "NP",
  "NQ",
  "NR",
  "NS",
  "NT",
  "NU",
  "NV",
  "NW",
  "NX",
  "NY",
  "NZ",
  "NÃ†",
  "NÃ˜",
  "NÃ…",
  "OA",
  "OB",
  "OC",
  "OD",
  "OE",
  "OF",
  "OG",
  "OH",
  "OI",
  "OJ",
  "OK",
  "OL",
  "OM",
  "ON",
  "OO",
  "OP",
  "OQ",
  "OR",
  "OS",
  "OT",
  "OU",
  "OV",
  "OW",
  "OX",
  "OY",
  "OZ",
  "OÃ†",
  "OÃ˜",
  "OÃ…",
  "PA",
  "PB",
  "PC",
  "PD",
  "PE",
  "PF",
  "PG",
  "PH",
  "PI",
  "PJ",
  "PK",
  "PL",
  "PM",
  "PN",
  "PO",
  "PP",
  "PQ",
  "PR",
  "PS",
  "PT",
  "PU",
  "PV",
  "PW",
  "PX",
  "PY",
  "PZ",
  "PÃ†",
  "PÃ˜",
  "PÃ…",
  "RA",
  "RB",
  "RC",
  "RD",
  "RE",
  "RF",
  "RG",
  "RH",
  "RI",
  "RJ",
  "RK",
  "RL",
  "RM",
  "RN",
  "RO",
  "RP",
  "RQ",
  "RR",
  "RS",
  "RT",
  "RU",
  "RV",
  "RW",
  "RX",
  "RY",
  "RZ",
  "RÃ†",
  "RÃ˜",
  "RÃ…",
  "SA",
  "SB",
  "SC",
  "SD",
  "SE",
  "SF",
  "SG",
  "SH",
  "SI",
  "SJ",
  "SK",
  "SL",
  "SM",
  "SN",
  "SO",
  "SP",
  "SQ",
  "SR",
  "SS",
  "ST",
  "SU",
  "SV",
  "SW",
  "SX",
  "SY",
  "SZ",
  "SÃ†",
  "SÃ˜",
  "SÃ…",
  "TA",
  "TB",
  "TC",
  "TD",
  "TE",
  "TF",
  "TG",
  "TH",
  "TI",
  "TJ",
  "TK",
  "TL",
  "TM",
  "TN",
  "TO",
  "TP",
  "TQ",
  "TR",
  "TS",
  "TT",
  "TU",
  "TV",
  "TW",
  "TX",
  "TY",
  "TZ",
  "TÃ†",
  "TÃ˜",
  "TÃ…",
  "UA",
  "UB",
  "UC",
  "UD",
  "UE",
  "UF",
  "UG",
  "UH",
  "UI",
  "UJ",
  "UK",
  "UL",
  "UM",
  "UN",
  "UO",
  "UP",
  "UQ",
  "UR",
  "US",
  "UT",
  "UU",
  "UV",
  "UW",
  "UX",
  "UY",
  "UZ",
  "UÃ†",
  "UÃ˜",
  "UÃ…",
  "VA",
  "VB",
  "VC",
  "VD",
  "VE",
  "VF",
  "VG",
  "VH",
  "VI",
  "VJ",
  "VK",
  "VL",
  "VM",
  "VN",
  "VO",
  "VP",
  "VQ",
  "VR",
  "VS",
  "VT",
  "VU",
  "VV",
  "VW",
  "VX",
  "VY",
  "VZ",
  "VÃ†",
  "VÃ˜",
  "VÃ…",
  "YA",
  "YB",
  "YC",
  "YD",
  "YE",
  "YF",
  "YG",
  "YH",
  "YI",
  "YJ",
  "YK",
  "YL",
  "YM",
  "YN",
  "YO",
  "YP",
  "YQ",
  "YR",
  "YS",
  "YT",
  "YU",
  "YV",
  "YW",
  "YX",
  "YY",
  "YZ",
  "YÃ†",
  "YÃ˜",
  "YÃ…",
  "Ã†A",
  "Ã†B",
  "Ã†C",
  "Ã†D",
  "Ã†E",
  "Ã†F",
  "Ã†G",
  "Ã†H",
  "Ã†I",
  "Ã†J",
  "Ã†K",
  "Ã†L",
  "Ã†M",
  "Ã†N",
  "Ã†O",
  "Ã†P",
  "Ã†Q",
  "Ã†R",
  "Ã†S",
  "Ã†T",
  "Ã†U",
  "Ã†V",
  "Ã†W",
  "Ã†X",
  "Ã†Y",
  "Ã†Z",
  "Ã†Ã†",
  "Ã†Ã˜",
  "Ã†Ã…",
  "Ã˜A",
  "Ã˜B",
  "Ã˜C",
  "Ã˜D",
  "Ã˜E",
  "Ã˜F",
  "Ã˜G",
  "Ã˜H",
  "Ã˜I",
  "Ã˜J",
  "Ã˜K",
  "Ã˜L",
  "Ã˜M",
  "Ã˜N",
  "Ã˜O",
  "Ã˜P",
  "Ã˜Q",
  "Ã˜R",
  "Ã˜S",
  "Ã˜T",
  "Ã˜U",
  "Ã˜V",
  "Ã˜W",
  "Ã˜X",
  "Ã˜Y",
  "Ã˜Z",
  "Ã˜Ã†",
  "Ã˜Ã˜",
  "Ã˜Ã…",
  "Ã…A",
  "Ã…B",
  "Ã…C",
  "Ã…D",
  "Ã…E",
  "Ã…F",
  "Ã…G",
  "Ã…H",
  "Ã…I",
  "Ã…J",
  "Ã…K",
  "Ã…L",
  "Ã…M",
  "Ã…N",
  "Ã…O",
  "Ã…P",
  "Ã…Q",
  "Ã…R",
  "Ã…S",
  "Ã…T",
  "Ã…U",
  "Ã…V",
  "Ã…W",
  "Ã…X",
  "Ã…Y",
  "Ã…Z",
  "Ã…Ã†",
  "Ã…Ã˜",
  "Ã…Ã…"
);

/**
 * Filmweb sitt GraphQL-endpoint for kinosÃ¸k
 */
function cinema_query($letter_combo = '')
{
    return 'https://skynet.filmweb.no/MovieInfoQs/graphql/?query=query($searchText:String){cinemaQuery{searchForLocations(searchText:$searchText){name}}}&variables={"searchText":"'. urlencode($letter_combo) . '"}';
}

/**
 * Gi oss Filmweb sitt GraphQL-endpoint for filmsÃ¸k pÃ¥ en lokasjon
 */
function movie_query($location = '')
{
    return 'https://skynet.filmweb.no/MovieInfoQs/graphql/?query=query($location:String){movieQuery{getCurrentMovies(location:$location,removePastShows:true){mainVersionId%20title%20genres%20lengthInMinutes%20rating%20poster{versions{url}}%20sanityImagePosterUrl%20shows{firmName%20showStart%20screenName%20ticketSaleUrl%20theaterName%20movieVersionId}}}}&variables={%22location%22:%22' . urlencode($location) . '%22}';
}

$all_locations = [];

foreach ($letter_combos as $combo) {

    if ($request = file_get_contents(cinema_query($combo))) {

        $result = json_decode($request);

        $locations = $result->data->cinemaQuery->searchForLocations;

        if ($result && !empty($locations)) {

            foreach($locations as $location) {

                if (!empty($location->name)) {

                    $location_array = array(
                        "name" => $location->name,
                        "slug" => get_slug($location->name)
                    );

                    if (!in_array($location_array, $all_locations)) {

                        array_push($all_locations, $location_array);

                        /**
                         * Hent filmer for denne kinoen
                         */
                        logg("ðŸ¿ Henter filmer for " . $location->name . "...");

                        $query_result = json_decode(file_get_contents(movie_query($location->name)));
                        $movies = $query_result->data->movieQuery->getCurrentMovies;

                        if ($query_result && !empty($movies)) {

                            $location_json = LOCATIONS_DIR . $location_array['slug'] . '.json';

                            file_put_contents($location_json, json_encode($movies));

                            foreach($movies as $movie) {

                                if (!empty($movie->sanityImagePosterUrl)) {

                                    $filename = IMG_DIR . $movie->mainVersionId . ".webp";

                                    if (!file_exists($filename)) {

                                        $poster_url = preg_replace('/auto=format/', 'fm=webp', $movie->sanityImagePosterUrl);

                                        list($width, $height) = getimagesize($poster_url);

                                        if ($width < 0 && $height > 0) {

                                          logg("â€“ Laster ned plakat til " . $movie->title . "...");

                                          $new_width = 450;
                                          $ratio = $height / $width;
                                          $new_height = intval($new_width * $ratio);

                                          $image_p = imagecreatetruecolor($new_width, $new_height);
                                          $image = imagecreatefromwebp($poster_url);
                                          imagecopyresampled($image_p, $image, 0, 0, 0, 0, $new_width, $new_height, $width, $height);

                                          imagewebp($image_p, IMG_DIR . $movie->mainVersionId . ".webp", 50);

                                          imagedestroy($image);
                                          imagedestroy($image_p);
                                        }
                                    }

                                } else {
                                    //logg("â€“ Fikk ikke tak i plakat til " . $movie->title . "...");
                                }

                            }

                        }
                    }
                }
            }
        }
    }
}

file_put_contents( LOCATIONS_DIR . 'all_locations.json', json_encode($all_locations));
delete_old_locations('-1 day 5 minutes');
